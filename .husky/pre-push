#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push quality gates..."

# Run full test suite with coverage
echo "ğŸ§ª Running full test suite with coverage..."
npm test -- --coverage --watchAll=false || exit 1

# Check coverage thresholds
echo "ğŸ“Š Checking coverage thresholds..."
COVERAGE=$(npm test -- --coverage --watchAll=false --coverageReporters=text-summary | grep "Statements" | awk '{print $3}' | sed 's/%//')
echo "Current coverage: $COVERAGE%"
if [ "$COVERAGE" -lt 80 ]; then
  echo "âŒ Coverage $COVERAGE% is below 80% threshold"
  echo "Please improve test coverage before pushing."
  exit 1
fi

# Build verification
echo "ğŸ”¨ Building application..."
npm run build || exit 1

# Security audit
echo "ğŸ” Running security audit..."
npm audit --audit-level=moderate || exit 1

# Check for production warnings in README
echo "ğŸ“– Checking documentation..."
if ! grep -q "NOT PRODUCTION READY" README.md; then
  echo "âš ï¸  Warning: README.md missing production warning"
fi

echo "âœ… Pre-push checks passed!" 